# Модуль "Управление телефонными группами"

Модуль "Управление телефонными группами" для MikoPBX позволяет организовывать сотрудников в группы с настраиваемыми правами на звонки и ограничениями. Это обеспечивает гибкий контроль доступа и помогает соблюдать корпоративные политики звонков.

## Описание

Модуль позволяет администраторам:

- **Организовывать пользователей в группы** - создавать отделы, команды или любые логические группировки
- **Контролировать права на звонки** - ограничивать, кто может звонить кому на основе принадлежности к группе
- **Управлять исходящей маршрутизацией** - контролировать, какие группы могут использовать определенные исходящие маршруты
- **Настраивать caller ID** - устанавливать разные номера определителя для исходящих звонков по группам
- **Изолировать перехват вызовов** - ограничивать функцию перехвата вызовов внутри групп
- **Голосовые уведомления** - воспроизводить настраиваемые сообщения при ограничении звонков

## Основные возможности

### Управление телефонными группами

Создавайте неограниченное количество групп пользователей и назначайте в них сотрудников. Каждая группа может иметь:

- **Уникальное название и описание** для простой идентификации
- **Пользовательские шаблоны звонков** - определение номеров, на которые группа может звонить
- **Настройки изоляции** - ограничение звонков внутри группы или на определенные шаблоны
- **Группа по умолчанию** - автоматическое назначение новых пользователей в выбранную группу

### Ограничения звонков

#### Режим изоляции

Когда для группы включена изоляция:
- Члены группы могут звонить только другим членам той же группы
- Члены группы могут звонить на внешние номера, соответствующие определенным шаблонам
- Члены группы не могут звонить пользователям из других групп
- Пользователи вне группы все еще могут звонить изолированным членам

**Примеры шаблонов:**
```
_7XXX              # 4-значные внутренние номера, начинающиеся с 7
_8XXXXXXXXXX       # 11-значные номера, начинающиеся с 8
*80                # Конкретные сервисные коды
112                # Экстренные номера
```

#### Примеры использования

- **Группа ресепшн** - без ограничений, может звонить всем
- **Финансовый отдел** - изолирован на внутренние номера финансов + конкретные внешние номера
- **Отдел продаж** - может звонить внутри команды + шаблоны номеров клиентов
- **Руководство** - без ограничений, полный доступ

### Контроль исходящих маршрутов

Назначайте определенные исходящие маршруты группам и устанавливайте пользовательские caller ID:

- Контролируйте, какие группы могут использовать дорогие международные маршруты
- Отображайте определители номера конкретных отделов для исходящих звонков
- Предотвращайте несанкционированное использование премиум-маршрутов
- Автоматически восстанавливайте исходный caller ID после завершения звонка

### Ограничения перехвата вызовов

Когда включена изоляция перехвата:
- Пользователи могут перехватывать только звонки членов своей группы
- Предотвращается случайный или несанкционированный перехват вызовов
- Сохраняется конфиденциальность внутри отделов

### Голосовые уведомления

Когда пользователь пытается совершить запрещенный звонок:
- Система воспроизводит настраиваемое голосовое сообщение
- Поддержка 30+ языков с автоматическим выбором
- Резервный вариант со стандартным системным сообщением, если пользовательское аудио недоступно
- Возможность использования пользовательских хуков обработки вызовов для расширенных сценариев

## Установка

### Требования

- MikoPBX версии **2023.2.179** или выше
- PHP 7.4 или выше

### Шаги установки

1. Откройте веб-интерфейс MikoPBX
2. Перейдите в **Система** → **Модули расширений**
3. Нажмите **Загрузить модуль** и выберите файл модуля
4. Нажмите **Включить** для активации модуля
5. Меню модуля появится в **Маршрутизация** → **Управление телефонными группами**

## Настройка

### Создание первой группы

1. Перейдите в **Маршрутизация** → **Управление телефонными группами**
2. Нажмите кнопку **Добавить группу**
3. Введите информацию о группе:
   - **Название** - уникальный идентификатор (например, "Отдел продаж")
   - **Описание** - необязательное подробное описание
4. Настройте изоляцию (при необходимости):
   - Включите чекбокс **Изоляция** для ограничения звонков
   - Добавьте разрешенные шаблоны номеров (по одному на строку)
5. Назначьте пользователей:
   - Переключитесь на вкладку **Пользователи**
   - Перетащите пользователей из доступного списка в выбранный
6. Настройте исходящие маршруты (опционально):
   - Переключитесь на вкладку **Исходящие правила**
   - Отметьте разрешенные маршруты
   - Введите пользовательский caller ID для каждого маршрута
7. Нажмите **Сохранить**

### Установка группы по умолчанию

После создания группы укажите ее группой по умолчанию и она автоматически прсвоится всем сотрудникам.

**Примечание:** Новые пользователи будут автоматически назначаться в группу по умолчанию.

### Назначение пользователей в группы

**Способ 1: При создании группы**
- Используйте вкладку "Пользователи" для выбора членов группы

**Способ 2: Из вкладки "Пользователи"**
- Перейдите в **Маршрутизация** → **Управление телефонными группами** → вкладка **Пользователи**
- Используйте выпадающий список в строке каждого пользователя для смены группы

**Способ 3: При редактировании карточки сотрудника**
- Перейдите в **Сотрудники** → **Откройте карточку**
- Выберите группу и сохраните

### Настройка ограничений звонков

Чтобы ограничить звонки для группы:

1. Отредактируйте группу
2. Включите чекбокс **Изоляция**
3. Добавьте разрешенные шаблоны в текстовое поле (по одному на строку)
4. Сохраните изменения

**Примеры шаблонов:**
- `_7XXX` - Разрешить 4-значные номера, начинающиеся с 7
- `_8[0-5]XXXXXXX` - Разрешить 8-значные номера, начинающиеся с 8,80,81,82,83,84,85
- `*80` - Разрешить конкретный код
- `112` - Разрешить экстренный номер

**Тестирование:**
- Звонок от изолированного пользователя другому члену той же группы → Должен работать
- Звонок от изолированного пользователя на номер, соответствующий шаблону → Должен работать
- Звонок от изолированного пользователя на несоответствующий номер → Должен быть заблокирован

### Настройка исходящих маршрутов

Чтобы контролировать, какие маршруты может использовать группа:

1. Отредактируйте группу
2. Перейдите на вкладку **Исходящие правила**
3. Отметьте маршруты, к которым должна иметь доступ эта группа
4. Опционально введите пользовательский caller ID для каждого маршрута
5. Сохраните изменения

**Пример:**
- Группа продаж: Разрешить маршруты "Городские" и "Бесплатные" с caller ID 555-0100
- Группа поддержки: Разрешить только "Городские" с caller ID 555-0200
- Руководство: Разрешить все маршруты без пользовательских caller ID

## Настройка голосовых уведомлений

### Базовая настройка

Модуль автоматически воспроизводит сообщение при блокировке звонков. По умолчанию используется стандартное сообщение Asterisk "номер не обслуживается".


## REST API

Модуль предоставляет REST API эндпоинты для интеграции с внешними системами.

**Базовый URL:** `http://your-pbx.com/pbxcore/api/modules/ModuleUsersGroups/`

### Доступные действия

- `getUserGroup` - Получить назначенную группу пользователя
- `updateUserGroup` - Изменить членство пользователя в группе
- `getDefaultGroup` - Получить группу по умолчанию
- `setDefaultGroup` - Установить группу по умолчанию
- `getGroupsStats` - Получить количество членов для всех групп
- `cleanupOrphanedMembers` - Удалить недействительные членства в группах


## Устранение неполадок

### Пользователи не ограничены, несмотря на изоляцию

**Проверьте:**
1. Пользователь действительно назначен в изолированную группу
2. Набираемый номер не соответствует разрешенным шаблонам


### Исходящие маршруты не учитывают права

**Проверьте:**
1. Для группы включен маршрут на вкладке "Исходящие правила"
2. Модуль включен и конфигурация перезагружена

**Решение:**
Отключите и снова включите модуль для пересоздания конфигурации.

### Перехват вызовов не изолирован

**Проверьте:**
1. Чекбокс изоляции перехвата включен для группы
2. Оба пользователя находятся в одной группе

### Изменения не вступают в силу

После внесения любых изменений:
1. Сохраните настройки группы
2. Дождитесь автоматической перезагрузки конфигурации (5-10 секунд)

## Часто задаваемые вопросы

**В: Могу ли я назначить пользователя в несколько групп?**
О: Нет, каждый пользователь может принадлежать только к одной группе одновременно.

**В: Что происходит при удалении группы?**
О: Пользователи из удаленной группы будут автоматически перемещены в группу по умолчанию.

**В: Могу ли я удалить группу по умолчанию?**
О: Нет, сначала необходимо установить другую группу по умолчанию перед ее удалением.

**В: Изолированные группы блокируют экстренные вызовы?**
О: Нет, если вы включите экстренные шаблоны (например, 112) в разрешенные шаблоны, они будут работать.

**В: Могут ли неизолированные пользователи звонить изолированным пользователям?**
О: Да, изоляция ограничивает только исходящие звонки от членов изолированной группы.

**В: Сколько групп я могу создать?**
О: Неограниченно. Модуль не накладывает никаких ограничений на количество групп.

**В: Будет ли изоляция работать для SIP транков?**
О: Да, изоляция работает для всех типов звонков - внутренних, внешних и через транки.

**В: Могу ли я использовать разные голосовые сообщения для разных групп?**
О: В настоящее время используется одно сообщение на язык для всех групп. Пользовательские сообщения для каждой группы требуют модификаций диалплана.

## Поддержка

### Документация

- **Английский:** [https://docs.mikopbx.com/mikopbx/v/english/modules/miko/module-users-groups](https://docs.mikopbx.com/mikopbx/v/english/modules/miko/module-users-groups)
- **Русский:** [https://docs.mikopbx.com/mikopbx/modules/miko/module-users-groups](https://docs.mikopbx.com/mikopbx/modules/miko/module-users-groups)

### Контакты

- **Email:** help@miko.ru
- **Разработчик:** MIKO LLC
- **Веб-сайт:** [https://www.mikopbx.com](https://www.mikopbx.com)

### Системные требования

- **Минимальная версия MikoPBX:** 2023.2.179
- **Версия PHP:** 7.4 или выше

## Лицензия

Этот модуль лицензирован под GNU GPL v3.0. См. файл [LICENSE](LICENSE) для деталей.

---

## Последние обновления

**Версия Ноябрь 2025:**
- Добавлена система голосовых уведомлений с поддержкой многоязычности
- Автоматический резервный вариант со стандартными звуками Asterisk
- Исправлено автоматическое заполнение пользователей при установке группы по умолчанию
- Добавлена очистка зтарых записей членства в группе при восстановлении из бекапа, когда часть сотрудников было удалено.
- Улучшен REST API с выделенными классами действий
- Расширена обработка ошибок и логирование

---